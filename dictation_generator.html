<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G√©n√©rateur de Dict√©es Niveau Brevet</title>
    <!-- Chargement de Tailwind CSS pour un design moderne et responsive -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'background': '#1f2937', // Gris fonc√©/Bleu marine
                        'card-bg': '#374151', // Gris moyen pour les cartes
                        'text-light': '#f3f4f6', // Texte clair
                        'primary': '#a78bfa', // Lavande clair pour le contraste
                        'secondary': '#34d399', // Vert menthe pour le succ√®s
                        'accent': '#f97316', // Orange br√ªl√© pour l'action/avertissement
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['Roboto Mono', 'monospace'],
                    },
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #111827; /* Noir tr√®s sombre pour le fond */
            font-family: 'Inter', sans-serif;
            color: #f3f4f6;
        }
        .card {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5), 0 2px 4px -1px rgba(0, 0, 0, 0.4);
            border-radius: 0.75rem;
            background-color: #1f2937; /* Background des cartes */
            border: 1px solid #374151;
        }
        
        /* Styles des boutons */
        .btn-primary {
            background-color: #4f46e5;
            transition: all 0.2s;
            box-shadow: 0 2px #3730a3; /* Ombre int√©rieure pour l'effet 3D */
            border-radius: 0.5rem;
        }
        .btn-primary:hover {
            background-color: #4338ca;
            transform: translateY(-1px);
            box-shadow: 0 4px #3730a3;
        }
        .btn-accent {
            background-color: #f97316;
            transition: all 0.2s;
            box-shadow: 0 2px #c2410c;
        }
        .btn-accent:hover {
            background-color: #ea580c;
            transform: translateY(-1px);
            box-shadow: 0 4px #c2410c;
        }

        /* Styles des champs de saisie */
        .form-input {
            background-color: #111827; /* Tr√®s sombre pour le champ */
            color: #f3f4f6;
            border: 1px solid #4b5563;
            border-radius: 0.5rem;
            padding: 0.75rem;
            transition: border-color 0.2s;
        }
        .form-input:focus {
            border-color: #a78bfa;
            box-shadow: 0 0 0 1px #a78bfa;
        }
        
        /* Styles sp√©cifiques pour les bo√Ætes de r√©sultats */
        .dictation-display {
            font-family: 'mono', monospace; /* Police mono pour le texte source */
            background-color: #030712; /* Noir absolu pour la zone de dict√©e */
            color: #d1d5db;
            padding: 1rem;
            border: 2px dashed #4b5563;
            border-radius: 0.5rem;
            font-size: 1.1rem;
        }
        
        .correction-box-generated {
            background-color: #1f2937;
            border-left: 4px solid #34d399; /* Vert Menthe */
        }
        .correction-box-ia {
            background-color: #1f2937;
            border-left: 4px solid #f97316; /* Orange Br√ªl√© */
        }
        
        /* Styles des titres dans les bo√Ætes de correction */
        #correctionContent h3, #detailedAnalysis h3 { 
            color: #34d399; 
            font-size: 1.4rem; 
            font-weight: 700; 
            margin-top: 1.5rem; 
            border-bottom: 1px solid #374151; 
            padding-bottom: 0.5rem; 
        }
        #correctionContent h4, #detailedAnalysis h4 { 
            color: #a78bfa; 
            font-size: 1.1rem; 
            font-weight: 600; 
            margin-top: 1rem; 
        }
        #correctionContent ul, #detailedAnalysis ul { 
            list-style: disc; 
            margin-left: 1.5rem; 
            padding-left: 0; 
            color: #d1d5db;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="app" class="max-w-4xl mx-auto">
        <header class="text-center mb-8 p-6 card">
            <h1 class="text-3xl md:text-4xl font-extrabold text-primary mb-2">
                Outil de R√©vision - Dict√©e DNB 3√®me
            </h1>
            <p class="text-gray-400">G√©n√©rez et corrigez vos dict√©es avec intelligence et pr√©cision acad√©mique.</p>
        </header>

        <!-- Configuration API Key -->
        <div class="card p-6 mb-8 border-l-4 border-accent">
            <h2 class="text-xl font-semibold text-accent mb-3">Configuration API</h2>
            <p class="text-sm text-gray-400 mb-3">Veuillez ins√©rer votre cl√© API Google AI Studio pour utiliser l'IA (n√©cessaire en ligne).</p>
            <input type="password" id="apiKeyInput" placeholder="Cl√© API (commence par 'AIza...')" class="w-full form-input">
        </div>

        <!-- Formulaire de g√©n√©ration -->
        <div class="card p-6 mb-8">
            <h2 class="text-2xl font-semibold text-text-light mb-4 border-b border-gray-600 pb-2">Param√®tres de l'Exercice</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <!-- Th√®me -->
                <div>
                    <label for="themeInput" class="block text-sm font-medium text-gray-300 mb-1">Th√®me</label>
                    <input type="text" id="themeInput" placeholder="Saisir un th√®me (facultatif)" class="w-full form-input">
                </div>
                
                <!-- Temps de conjugaison -->
                <div>
                    <label for="tenseSelect" class="block text-sm font-medium text-gray-300 mb-1">Temps de conjugaison cibl√©</label>
                    <select id="tenseSelect" class="w-full form-input appearance-none">
                        <option value="Aucun">Aucun (Vari√©)</option>
                        <option value="Pr√©sent de l'indicatif">Pr√©sent de l'indicatif</option>
                        <option value="Imparfait de l'indicatif">Imparfait de l'indicatif</option>
                        <option value="Pass√© simple">Pass√© simple (Difficult√© Brevet)</option>
                        <option value="Futur simple">Futur simple</option>
                        <option value="Conditionnel pr√©sent">Conditionnel pr√©sent</option>
                        <option value="Subjonctif pr√©sent">Subjonctif pr√©sent (Haute difficult√©)</option>
                        <option value="Temps compos√©s (Pass√© compos√©, Plus-que-parfait)">Temps compos√©s (Accords du participe pass√©)</option>
                    </select>
                </div>

                <!-- Longueur de la dict√©e -->
                <div>
                    <label for="lengthSelect" class="block text-sm font-medium text-gray-300 mb-1">Longueur</label>
                    <select id="lengthSelect" class="w-full form-input appearance-none">
                        <option value="brevet">Brevet (100% - Standard)</option>
                        <option value="moyenne">Moyenne (75% - Entra√Ænement)</option>
                        <option value="rapide">Rapide (50% - √âchauffement)</option>
                    </select>
                </div>
            </div>

            <!-- Bouton de g√©n√©ration -->
            <button id="generateBtn" onclick="generateDictation()" class="w-full btn-primary text-text-light font-bold py-3 rounded-lg shadow-lg">
                G√©n√©rer la Dict√©e
            </button>
        </div>

        <!-- Section du statut (chargement/erreurs) -->
        <div id="statusMessage" class="hidden p-4 rounded-lg text-center font-medium transition-all duration-300" role="status"></div>

        <!-- Section des R√©sultats de G√©n√©ration -->
        <div id="resultsContainer" class="hidden">
            <h2 class="text-3xl font-bold text-primary mb-6 border-b border-gray-600 pb-2">1. Texte et Correction Officielle</h2>
            
            <!-- Dict√©e √† lire -->
            <div id="dictationArea" class="card p-6 mb-8">
                <h3 class="text-xl font-semibold text-primary mb-4 flex items-center">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                    Texte de la Dict√©e (√Ä lire)
                </h3>
                <div id="dictationText" class="dictation-display whitespace-pre-wrap"></div>
            </div>

            <!-- Correction et Bar√®me g√©n√©r√©s -->
            <div id="correctionArea" class="card p-6 correction-box-generated">
                <h3 class="text-xl font-semibold text-secondary mb-4 flex items-center">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    Correction D√©taill√©e et Bar√®me de Notation Brevet
                </h3>
                <div id="correctionContent" class="text-base text-gray-300 prose max-w-none"></div>
            </div>
        </div>
        
        <!-- Section de Correction par Image -->
        <div id="imageCorrectionSection" class="card p-6 mt-8 hidden">
            <h2 class="text-3xl font-bold text-accent mb-6 border-b border-gray-600 pb-2">2. Correction de votre copie (par IA)</h2>
            <p class="text-gray-400 mb-4">Prenez une photo nette de votre dict√©e manuscrite pour une correction et une note automatique.</p>
            
            <input type="file" id="dictationImageInput" accept="image/*" class="mb-4 block w-full text-sm text-gray-300 border border-gray-600 rounded-lg cursor-pointer bg-card-bg focus:outline-none p-2 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-primary file:text-white">

            <div id="imagePreviewContainer" class="mb-4 hidden">
                <p class="text-sm font-medium mb-2 text-gray-400">Aper√ßu de la copie :</p>
                <img id="imagePreview" class="max-w-full h-auto rounded-lg border border-gray-600 mx-auto" style="max-height: 250px; object-fit: contain;">
            </div>
            
            <button id="correctBtn" onclick="correctDictationImage()" class="w-full btn-accent text-text-light font-bold py-3 rounded-lg shadow-lg disabled:opacity-50" disabled>
                Lancer la Correction et la Notation
            </button>
            
            <!-- R√©sultats de la correction -->
            <div id="correctionResults" class="mt-6 hidden correction-box-ia p-4">
                <h3 class="text-xl font-bold text-accent mb-2">R√©sultat et Note Finale</h3>
                <p class="text-2xl font-extrabold text-secondary mb-4">Note Estim√©e : <span id="finalScore">-- / 20</span></p>
                
                <h4 class="text-lg font-semibold text-gray-300 border-t border-gray-600 pt-2 mt-4">Analyse D√©taill√©e (Erreurs Identifi√©es)</h4>
                <div id="detailedAnalysis" class="text-gray-300 prose max-w-none mt-2"></div>
            </div>
        </div>

        <footer class="mt-8 text-center text-sm text-gray-500 border-t border-gray-700 pt-4">
            Application Gemini - Outil d'aide √† la r√©vision acad√©mique.
        </footer>
    </div>

    <script type="module">
        // --- Imports Firebase (Boilerplate) ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Variables globales (r√©cup√©r√©es de l'environnement Canvas)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // La cl√© API est maintenant r√©cup√©r√©e du champ de saisie
        let apiKey = ""; 
        const GEMINI_MODEL = "gemini-2.5-flash-preview-05-20";


        let app;
        let auth;
        let db;
        let userId = null;
        let isAuthReady = false;
        
        // --- Variables de l'application pour le flux de correction ---
        let currentDictationText = null; // Texte correct g√©n√©r√© (pour la comparaison)
        let currentBar√®me = null; // Bar√®me g√©n√©r√© (pour l'application de la note)

        // √âl√©ments du DOM
        const apiKeyInput = document.getElementById('apiKeyInput'); // NOUVEAU
        const statusMessage = document.getElementById('statusMessage');
        const dictationTextEl = document.getElementById('dictationText');
        const correctionContentEl = document.getElementById('correctionContent');
        const resultsContainer = document.getElementById('resultsContainer');
        const generateBtn = document.getElementById('generateBtn');
        const correctBtn = document.getElementById('correctBtn');
        const imageCorrectionSection = document.getElementById('imageCorrectionSection');
        const dictationImageInput = document.getElementById('dictationImageInput');

        // --- Initialisation Firebase (Omis pour la clart√©, mais le boilerplate est conserv√©) ---
        if (firebaseConfig) {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                setLogLevel('Debug');
                
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                    } else {
                        try {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                await signInAnonymously(auth);
                            }
                        } catch (error) {
                            console.error("Erreur d'authentification Firebase:", error);
                        }
                    }
                    isAuthReady = true;
                });
            } catch (e) {
                console.error("Erreur lors de l'initialisation de Firebase:", e);
            }
        }

        // V√©rifie si la cl√© API est pr√©sente
        function checkApiKey() {
            apiKey = apiKeyInput.value.trim();
            if (!apiKey) {
                setStatus("Veuillez saisir votre cl√© API pour commencer.", 'error', true);
                generateBtn.disabled = true;
                return false;
            }
            generateBtn.disabled = false;
            return true;
        }

        // √âcoute les changements dans le champ de la cl√© API
        apiKeyInput.addEventListener('input', checkApiKey);
        
        // Fonction utilitaire pour afficher les messages de statut
        function setStatus(message, type = 'info', isVisible = true) {
            statusMessage.textContent = message;
            statusMessage.className = `p-4 rounded-lg text-center font-medium transition-all duration-300 ${isVisible ? '' : 'hidden'}`;
            
            const is_loading = type === 'loading';

            if (is_loading) {
                statusMessage.classList.add('bg-blue-800', 'text-white', 'animate-pulse');
                generateBtn.disabled = true;
                correctBtn.disabled = true; // D√©sactiver les deux boutons
                generateBtn.innerHTML = `
                    <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    G√©n√©ration en cours...`;
            } else {
                statusMessage.classList.remove('bg-blue-800', 'text-white', 'animate-pulse');
                
                if (type === 'error') {
                    statusMessage.classList.add('bg-red-800', 'text-white');
                } else if (type === 'success') {
                    statusMessage.classList.add('bg-secondary', 'text-gray-900');
                } else {
                    statusMessage.classList.add('bg-card-bg', 'text-gray-300');
                }
                
                // R√©activer les boutons si la cl√© est pr√©sente
                generateBtn.disabled = !checkApiKey();
                if (currentDictationText !== null && dictationImageInput.files.length > 0) {
                     correctBtn.disabled = false;
                } else {
                     correctBtn.disabled = true;
                }
                generateBtn.textContent = 'G√©n√©rer la Dict√©e';
            }
        }

        // Fonction de conversion Markdown tr√®s basique pour l'affichage
        function convertMarkdownToHtml(markdown) {
            let html = markdown || '';
            
            // Remplacer les titres (ajust√© pour la correction)
            html = html.replace(/^### (.*$)/gim, '<h4 class="text-lg font-semibold mt-4 mb-2 text-primary">$1</h4>');
            html = html.replace(/^## (.*$)/gim, '<h3 class="text-xl font-bold mt-6 mb-3 text-secondary border-b pb-1">$1</h3>');

            // Remplacer les listes
            html = html.replace(/^\* (.*$)/gim, '<li class="ml-5 list-disc text-sm">$1</li>');
            html = html.replace(/^- (.*$)/gim, '<li class="ml-5 list-disc text-sm">$1</li>');
            
            // Ajouter des balises <ul> autour des listes
            // Attention: cette conversion simple peut n√©cessiter un nettoyage si le markdown est tr√®s complexe
            let ul_html = html.split('\n').map(line => {
                if (line.trim().startsWith('<li')) {
                    return line;
                }
                return `__PARA__${line}`;
            }).join('\n');

            ul_html = ul_html.replace(/__PARA__<li/g, '</ul>\n<ul><li');
            ul_html = ul_html.replace(/<li__PARA__/g, '</li></ul>\n<ul>__PARA__');
            ul_html = `<ul>${ul_html}</ul>`;
            
            // Nettoyage des balises <ul> vides ou mal plac√©es
            ul_html = ul_html.replace(/<ul>\s*<\/ul>/g, '');
            ul_html = ul_html.replace(/__PARA__/g, '\n');
            html = ul_html;

            // Remplacer le gras
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            
            // Remplacer les retours √† la ligne par des paragraphes
            html = html.split('\n').filter(p => p.trim() !== '').map(p => {
                // Si la ligne ne commence pas par une balise HTML (titres, listes, etc.)
                if (!p.startsWith('<h') && !p.startsWith('<ul') && !p.startsWith('<li') && !p.startsWith('</')) {
                    return `<p class="mb-3">${p}</p>`;
                }
                return p;
            }).join('');
            
            return html;
        }


        // --- LOGIQUE DE G√âN√âRATION (API 1) ---
        window.generateDictation = async function() {
            if (!checkApiKey()) return;

            const theme = document.getElementById('themeInput').value.trim();
            const tense = document.getElementById('tenseSelect').value;
            const length = document.getElementById('lengthSelect').value; 

            if (tense === "Aucun" && theme === "") {
                setStatus("Veuillez choisir un th√®me, un temps de conjugaison, ou la longueur Brevet.", 'error', true);
                return;
            }

            // D√©terminer la longueur cible en signes (caract√®res)
            let lengthInstruction = "";
            if (length === "rapide") {
                lengthInstruction = "environ 300 √† 350 signes (caract√®res), soit environ 20-25 mots, pour un entra√Ænement rapide.";
            } else if (length === "moyenne") {
                lengthInstruction = "environ 450 √† 525 signes (caract√®res), soit environ 30-38 mots, pour une dur√©e mod√©r√©e.";
            } else { // brevet
                lengthInstruction = "environ 600 √† 700 signes (caract√®res), soit environ 40-50 mots, comme une dict√©e de Brevet standard.";
            }


            setStatus("Pr√©paration du sujet... (cela peut prendre quelques secondes)", 'loading');
            resultsContainer.classList.add('hidden');
            imageCorrectionSection.classList.add('hidden');

            const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${apiKey}`;

            const systemPrompt = `
                Vous √™tes un professeur de fran√ßais, examinateur du Dipl√¥me National du Brevet (DNB).
                Votre r√¥le est de g√©n√©rer une dict√©e de niveau 3√®me (√©quivalent DNB), d'une longueur id√©ale de ${lengthInstruction}.
                La dict√©e doit inclure des difficult√©s grammaticales et orthographiques complexes typiques de l'√©preuve du Brevet.
                
                Vous devez OBLIGATOIREMENT r√©pondre avec un objet JSON strict, sans aucun pr√©ambule ni explication.

                Le JSON doit contenir les cl√©s suivantes :
                1. "dictationTitle": Le titre de l'extrait de dict√©e (String).
                2. "dictationText": Le texte int√©gral de la dict√©e. Il doit √™tre format√© pour la LECTURE (sans mise en page Markdown ni ast√©risques).
                3. "correctionAndBar√®me": Un bloc de texte au format Markdown contenant la correction d√©taill√©e et le bar√®me de notation.

                Dans le bloc "correctionAndBar√®me":
                - Incluez un sous-titre "Texte Corrig√© Officiel" o√π les difficult√©s sont mises en √©vidence (ex: en **gras** ou _soulign√©es_ dans le texte).
                - Incluez un sous-titre "Bar√®me de Notation (Similaire DNB - sur 20 points)" avec la liste des types d'erreurs et la d√©duction de points associ√©e (ex: -0,5 point, -1 point).
            `;

            let userQuery = `G√©n√®re une dict√©e de niveau Brevet sur le th√®me de "${theme || 'la litt√©rature classique'}"`;
            
            if (tense && tense !== "Aucun") {
                userQuery += ` et qui cible sp√©cifiquement l'utilisation du temps de conjugaison : **${tense}** (au moins 3 verbes complexes).`;
            } else {
                userQuery += `. Ne ciblez pas de temps sp√©cifique, utilisez une vari√©t√© (Pass√© Simple ou Imparfait, par exemple).`;
            }
            userQuery += ` Respecte le format JSON strict.`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            dictationTitle: { type: "STRING" },
                            dictationText: { type: "STRING" },
                            correctionAndBar√®me: { type: "STRING" }
                        },
                        propertyOrdering: ["dictationTitle", "dictationText", "correctionAndBar√®me"]
                    }
                }
            };

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    // Si l'erreur est 403, on donne un message sp√©cifique
                    if (response.status === 403) {
                         throw new Error(`Erreur 403: Cl√© API invalide ou acc√®s non autoris√©. Veuillez v√©rifier votre cl√© API.`);
                    }
                    throw new Error(`Erreur API: ${response.status} ${response.statusText}`);
                }

                const result = await response.json();
                const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (!jsonText) {
                    setStatus("Erreur: La r√©ponse de l'IA est vide ou mal format√©e.", 'error', true);
                    return;
                }

                const dictationData = JSON.parse(jsonText);
                
                // --- STOCKAGE DES DONN√âES CL√âS POUR LA CORRECTION PAR IMAGE ---
                currentDictationText = dictationData.dictationText; 
                currentBar√®me = dictationData.correctionAndBar√®me; 

                // Affichage des r√©sultats de g√©n√©ration
                dictationTextEl.innerHTML = `<h3 class="text-xl font-bold text-gray-300 mb-2">${dictationData.dictationTitle}</h3><hr class="mb-4 border-gray-600">` 
                                          + `<div class="dictation-display">${dictationData.dictationText.replace(/\n/g, '<br>')}</div>`;
                
                const correctionHtml = convertMarkdownToHtml(dictationData.correctionAndBar√®me);
                correctionContentEl.innerHTML = correctionHtml;

                setStatus("Dict√©e g√©n√©r√©e avec succ√®s ! üìù Faites la dict√©e, puis passez √† l'√©tape 2.", 'success', true);
                resultsContainer.classList.remove('hidden');
                imageCorrectionSection.classList.remove('hidden');
                document.getElementById('correctionResults').classList.add('hidden'); // Cacher l'ancien r√©sultat de correction
                
                // Mettre √† jour l'√©tat du bouton de correction d'image
                correctBtn.disabled = (dictationImageInput.files.length === 0);

            } catch (error) {
                console.error("Erreur lors de la g√©n√©ration de la dict√©e:", error);
                setStatus(`√âchec de la g√©n√©ration. D√©tails: ${error.message}.`, 'error', true);
            }
        }

        // --- GESTION DE L'IMAGE ET DE LA CORRECTION (API 2 - VISION) ---
        
        // G√©rer le changement de fichier pour l'aper√ßu et l'activation du bouton
        dictationImageInput.addEventListener('change', function(event) {
            const file = event.target.files[0];
            const preview = document.getElementById('imagePreview');
            const previewContainer = document.getElementById('imagePreviewContainer');

            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.src = e.target.result;
                    previewContainer.classList.remove('hidden');
                    // Activer le bouton si la dict√©e a √©t√© g√©n√©r√©e ET qu'un fichier est pr√©sent
                    correctBtn.disabled = (currentDictationText === null); 
                };
                reader.readAsDataURL(file);
            } else {
                preview.src = "";
                previewContainer.classList.add('hidden');
                correctBtn.disabled = true;
            }
        });


        window.correctDictationImage = async function() {
            if (!checkApiKey()) return;
            if (!currentDictationText || !currentBar√®me) {
                setStatus("Veuillez d'abord g√©n√©rer la dict√©e (√©tape 1).", 'error', true);
                return;
            }

            const fileInput = document.getElementById('dictationImageInput');
            if (fileInput.files.length === 0) {
                setStatus("Veuillez s√©lectionner une image de votre copie (√©tape 2).", 'error', true);
                return;
            }

            const file = fileInput.files[0];
            const reader = new FileReader();

            // Lire le fichier en Base64
            reader.onloadend = async function() {
                const base64Data = reader.result.split(',')[1];
                const mimeType = file.type;

                setStatus("Analyse de la copie et notation IA en cours... (patientez, l'analyse d'image est plus longue)", 'loading');
                document.getElementById('correctBtn').disabled = true;
                document.getElementById('correctionResults').classList.add('hidden');

                const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${apiKey}`;

                const correctionSystemPrompt = `
                    Vous √™tes un correcteur IA du Brevet (DNB) sp√©cialis√© en dict√©e. Votre t√¢che est d'analyser le texte manuscrit fourni dans l'image, de le comparer au texte correct fourni, d'identifier les erreurs et d'appliquer le bar√®me pour calculer une note finale sur 20.
                    
                    Instructions Cl√©s :
                    1. Vous devez d'abord transcrire le texte de l'√©l√®ve √† partir de l'image.
                    2. Comparez strictement cette transcription au TEXTE CORRECT fourni.
                    3. Appliquez le BAR√àME DE NOTATION fourni pour calculer la note finale sur 20.
                    4. R√©pondez OBLIGATOIREMENT avec un objet JSON STRICT.

                    Le JSON doit contenir les cl√©s suivantes :
                    1. "finalScore": La note finale calcul√©e, format√©e comme un nombre flottant (ex: 17.5).
                    2. "studentTranscription": Le texte que vous avez transcrit √† partir de l'image (String).
                    3. "detailedCorrection": Une analyse d√©taill√©e en Markdown. Incluez le texte de l'√©l√®ve **avec les erreurs mises en √©vidence en gras** et expliquez CLAIREMENT les erreurs (nature, ex: accord, conjugaison) et la d√©duction de points appliqu√©e, en r√©f√©rence au bar√®me.
                `;

                const correctionUserQuery = `
                    Veuillez corriger la dict√©e pr√©sente dans l'image.
                    ---
                    TEXTE CORRECT DE LA DICT√âE :
                    ${currentDictationText}
                    ---
                    BAR√àME √Ä APPLIQUER :
                    ${currentBar√®me}
                    ---
                    Correction :
                `;
                
                const payload = {
                    contents: [
                        {
                            role: "user",
                            parts: [
                                { text: correctionUserQuery },
                                {
                                    inlineData: {
                                        mimeType: mimeType,
                                        data: base64Data
                                    }
                                }
                            ]
                        }
                    ],
                    systemInstruction: { parts: [{ text: correctionSystemPrompt }] },
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "OBJECT",
                            properties: {
                                finalScore: { type: ["STRING", "NUMBER"] },
                                studentTranscription: { type: "STRING" },
                                detailedCorrection: { type: "STRING" }
                            },
                            propertyOrdering: ["finalScore", "studentTranscription", "detailedCorrection"]
                        }
                    }
                };

                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        // Si l'erreur est 403, on donne un message sp√©cifique
                        if (response.status === 403) {
                             throw new Error(`Erreur 403: Cl√© API invalide ou acc√®s non autoris√©. Veuillez v√©rifier votre cl√© API.`);
                        }
                        throw new Error(`Erreur API (Correction): ${response.status} ${response.statusText}`);
                    }

                    const result = await response.json();
                    const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                    if (!jsonText) {
                         setStatus("Erreur: La r√©ponse de l'IA est vide ou mal format√©e pour la correction.", 'error', true);
                         correctBtn.disabled = false;
                         return;
                    }

                    const correctionData = JSON.parse(jsonText);

                    // Affichage des r√©sultats de la correction
                    document.getElementById('finalScore').textContent = `${parseFloat(correctionData.finalScore).toFixed(1)} / 20`;
                    
                    // Affichage de l'analyse d√©taill√©e
                    const analysisHtml = convertMarkdownToHtml(correctionData.detailedCorrection);
                    document.getElementById('detailedAnalysis').innerHTML = analysisHtml;

                    document.getElementById('correctionResults').classList.remove('hidden');
                    setStatus("Correction termin√©e ! Consultez votre note et l'analyse d√©taill√©e ci-dessous.", 'success', true);
                    correctBtn.disabled = false;

                } catch (error) {
                    console.error("Erreur lors de la correction de l'image:", error);
                    setStatus(`√âchec de la correction. D√©tails: ${error.message}. Assurez-vous que l'image est nette et le texte lisible.`, 'error', true);
                    correctBtn.disabled = false;
                }
            };

            reader.readAsDataURL(file);
        }

        window.onload = function() {
            // Initialisation de la v√©rification de la cl√© API au chargement
            checkApiKey();
        };
    </script>
</body>
</html>
